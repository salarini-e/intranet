{% extends 'template_chamados.html' %}
{% block chamados %}active{% endblock %}
{% block title %}Tickets Chamados{% endblock %}
{% block css %}
<link rel="stylesheet" href="/static/css/tickets.css">
{% endblock %}
{% block main %}  
    <div class="row g-3 mb-4 align-items-center justify-content-between">
        <div class="col-auto">
            <h1 class="app-page-title tickets mb-0">Bem vindo aos tickets</h1>
        </div>
        {% if request.user.is_superuser%}
            <div class="col-auto">
                    <a href="{% url 'chamados:index' %}" class="my-auto btn app-btn-secondary"><i class="fa-solid fa-rotate-left me-2"></i>Voltar</a>
            
                <button class="my-auto btn p-4 py-2" id="mButtonFilters" 
                        data-bs-toggle="offcanvas" 
                        data-bs-target="#offcanvasScrolling" 
                        onclick="hiddenMenuFilters()"
                        >
                    <i class="fa-solid fa-angle-left"></i>Filtros
                </button>
            </div>
        {% endif %}
    </div>
    <!-- CARDS -->
    <div class="container">
        <div class="row">
            <!-- Coluna de 9 colunas -->
            <div class="col-lg-12" id="cards-wrapper" >
                {% for chamado in chamados %}
                    <div id="chamado-{{chamado.id}}" class="row ticket-chamado-background{% if chamado.status == '4' %} card-status-finalizado{% endif %}">
                        <div class="row">
                            <div class="col-1 m-auto checkbox-container">
                                <input type="checkbox" class="checkbox-tickets" onchange="toggleStatusCheckBox(this)">
                            </div>
                            <div class="col">
                                <div class="row">
                                    <div class="col-lg-8 col-sm-11 chamados-tickets-infos-chamado">
                                        <div class="chamados-tickets-infos-chamado-text">
                                            {% if chamado.is_novo %}
                                            <span class="chamados-tickets-infos-chamado-text-assunto validade-ticket"> Novo</span>
                                            {% endif %}
                                            <a href="{% url 'chamados:detalhes' chamado.hash %}">
                                                <span class="chamados-tickets-infos-chamado-text-assunto">
                                                    {{ chamado.assunto }} - {{ chamado.setor.secretaria }} #{{ chamado.id|stringformat:"04d" }}
                                                </span>
                                                </a>
                                            <div class="solution-infos-wrapper">
                                                <i class="fa-solid fa-globe" style="width: 10px;"></i>
                                                <span class="chamados-tickets-infos-chamado-text-requisitante">{{ chamado.user_inclusao }}
                                                    <i class="fa-solid fa-circle" style="width: 5px;"></i> Finalizado há 1 dia
                                                    <i class="fa-solid fa-circle" style="width: 5px;"></i> Resolvido no prazo</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 col-sm-11 chamados-tickets-infos">
                                        <!-- Verificação se o usuário é superusuário -->
                                        {% if request.user.is_superuser %}
                                            <!-- Dropdown para Prioridade -->
                                            <span class="prioridade text-line">
                                                <span id="indicadorPrioridade-{{chamado.id}}" class="prioridade-indicador {{ chamado.get_prioridade_class }}"></span>
                                                <div class="dropdown">
                                                    <a id="selectPrioridade-{{chamado.id}}" class="dropdown-toggle" 
                                                       type="button" 
                                                       data-bs-toggle="dropdown" 
                                                       aria-expanded="false" 
                                                       style="text-decoration: none; color: black;"
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="left" 
                                                       title="Prioridade">
                                                        {{ chamado.get_prioridade_display }}
                                                    </a>
                                                    <ul class="dropdown-menu">
                                                        {% for prioridade in chamado.PRIORIDADE_CHOICES %}
                                                            <li><a class="dropdown-item" href="#" onclick="mudar_prioridade('{{chamado.hash}}','{{prioridade.0}}')">{{prioridade.1}}</a></li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </span>
                                    
                                            <!-- Dropdown para Secretaria -->
                                            
                                            <!-- Dropdown para Status -->
                                            <span class="prioridade">
                                                <span id="indicadorStatus-{{chamado.id}}" class="prioridade-indicador {{ chamado.get_status_class }}"></span>
                                                <div class="dropdown">
                                                    <a class="dropdown-toggle" 
                                                       type="button" 
                                                       data-bs-toggle="dropdown" 
                                                       aria-expanded="false" 
                                                       style="text-decoration: none; color: black;"
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="left" 
                                                       title="Status"
                                                       id="statusSelect-{{chamado.id}}">
                                                        {{ chamado.get_status_display }}
                                                    </a>
                                                    <ul class="dropdown-menu">
                                                        {% for status in chamado.STATUS_CHOICES %}
                                                            <li><a class="dropdown-item" href="#" onclick="mudar_status('{{chamado.hash}}','{{status.0}}')">{{status.1}}</a></li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </span>
                                    
                                        <!-- Caso não seja superusuário, exibir apenas as informações sem permitir alterações -->
                                        {% else %}
                                            <span class="prioridade text-line">
                                                <span class="prioridade-indicador {{ chamado.get_prioridade_class }}"></span>
                                                {{ chamado.get_prioridade_display }}
                                            </span>
                                    
                                            <span class="prioridade">
                                                {{ chamado.setor.secretaria.apelido }} / {{ chamado.atendente }}
                                            </span>
                                    
                                            <span class="prioridade">
                                                <span class="prioridade-indicador {{ chamado.get_status_class }}"></span>
                                                {{ chamado.get_status_display }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div style="margin-top: 53px; z-index: 10; width: 280px; background-color: #f5f5f5;" 
                class="offcanvas offcanvas-end filters-wrapper" 
                data-bs-scroll="true" data-bs-backdrop="false" 
                tabindex="-1" id="offcanvasScrolling" 
                aria-labelledby="offcanvasScrollingLabel">

            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasScrollingLabel">Filtros</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" onclick="hiddenMenuFilters()"></button>
            </div>
            <!-- FILTRO -->
            <div class="offcanvas-body">
                <form method="POST" class="row" id="filter-form">
                    <div class="col">
                        {% csrf_token %}	
                        <div class="container mt-3" id="container-agentes">
                            <span class="filter-title-itens">Agentes incluem</span>
                            <div class="multi-select-input form-select" id="multiSelectInputAgentes">
                                {% if request.session.agentes %}
                                {% for agente in  request.session.agentes %}
                                <div class="selected-option" data-value="{{agente.id}}">{{agente.nome}} <button onclick="removeOption('{{agente.id}}', 'multiSelectInputAgentes')">×</button></div>
                                {% endfor %}
                                {% endif %}
                                <input type="hidden" name="agentes" id="id_agentes" {% if request.session.agentes %}value='{% for agente in  request.session.agentes %}{{agente.id}};{%endfor%}'{% endif %}>
                                <select id="agentesSelect" class="select-input form-select" aria-label="Select Agentes">
                                    <option value="" class="options-filter"></option>
                                    {% for atendente in atendentes %}
                                    <option value="{{ atendente.id }}" class="options-filter" {% if atendente.id|stringformat:"s" in agentes_selecionados %}selected{% endif %}>
                                        {{ atendente.nome_servidor }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>	
                        <div class="container mt-3" id="container-status">
                            <span class="filter-title-itens">Status incluem</span>
                            <div class="multi-select-input form-select" id="multiSelectInputStatus">
                                <input type="hidden" name="status" id="id_status">
                                <select id="statusSelect" class="select-input form-select" aria-label="Select Status">
                                    <option value="" class="options-filter"></option>
                                    {% for status in chamados.0.STATUS_CHOICES %}
                                        <option value="{{status.0}}" class="options-filter">{{status.1}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="container mt-3" id="container-grupos">
                            <span class="filter-title-itens">Grupos incluem</span>
                            <div class="multi-select-input form-select" id="multiSelectInputTiposChamados">
                                <input type="hidden" name="tiposChamados" id="id_chamados">
                                <select id="tiposChamadosSelect" class="select-input form-select" aria-label="Select Tipo Chamado">
                                    <option value="" class="options-filter"></option>
                                    {% for tipochamado in tipos_chamados %}
                                        <option value="{{tipochamado.id}}" class="options-filter">{{tipochamado.nome}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="container mt-3" id="container-prioridades">
                            <span class="filter-title-itens">Prioridades incluem</span>
                            <div class="multi-select-input form-select" id="multiSelectInputPrioridade">
                              
                                <input type="hidden" name="prioridade" id="id_prioridade">
                                <select id="PrioridadeSelect" class="select-input form-select" aria-label="Select Tipo Chamado">
                                    <option value="" class="options-filter"></option>
                                    {% for prioridade in chamados.0.PRIORIDADE_CHOICES %}
                                    <!-- a prioridade não definina n tem valor, aí entra como vazio -->
                                        <option value="{{prioridade.0}}" class="options-filter">{{prioridade.1}}</option>
                                    {% endfor %}
                                    
                                </select>
                            </div>
                        </div>  

                        <div class="container mt-3">
                            <span class="filter-title-itens">Criado</span>
                            <div class="multi-select-input" id="multiSelectInputCriado">
                                <select id="CriadoSelect" name="criadoEm" class="select-input form-select" aria-label="Select Tipo Chamado">
                                    <option value="" class="options-filter">Qualquer hora</option>
                                    <option value="5min" class="options-filter">Nos últimos 5 minutos</option>
                                    <option value="15min" class="options-filter">Nos últimos 15 minutos</option>
                                    <option value="30min" class="options-filter">Nos últimos 30 minutos</option>
                                    <option value="1hora" class="options-filter">Na última hora</option>
                                    <option value="4horas" class="options-filter">Nas últimas 4 horas</option>
                                    <option value="12horas" class="options-filter">Nas últimas 12 horas</option>
                                    <option value="24horas" class="options-filter">Nas últimas 24 horas</option>
                                    <option value="Hoje" class="options-filter">Hoje</option>
                                    <option value="Ontem" class="options-filter">Ontem</option>
                                    <option value="EstaSemana" class="options-filter">Esta semana</option>
                                    <option value="EsteMes" class="options-filter">Este mês</option>
                                    <option value="7dias" class="options-filter">Nos últimos 7 dias</option>
                                    <option value="30dias" class="options-filter">Nos últimos 30 dias</option>
                                    <option value="60dias" class="options-filter">Nos últimos 60 dias</option>
                                    <option value="180dias" class="options-filter">Nos últimos 180 dias</option>
                                </select>
                            </div>
                        </div> 
                        <div class="container mt-3">
                            <span class="filter-title-itens">Fechado em</span>
                            <div class="multi-select-input" id="multiSelectInputFechado">
                                <select id="FechadoSelect" name="fechadoEm" class="select-input form-select" aria-label="Select Tipo Chamado">
                                    <option value="" class="options-filter">Qualquer hora</option>
                                    <option value="5min" class="options-filter">Nos últimos 5 minutos</option>
                                    <option value="15min" class="options-filter">Nos últimos 15 minutos</option>
                                    <option value="30min" class="options-filter">Nos últimos 30 minutos</option>
                                    <option value="1hora" class="options-filter">Na última hora</option>
                                    <option value="4horas" class="options-filter">Nas últimas 4 horas</option>
                                    <option value="12horas" class="options-filter">Nas últimas 12 horas</option>
                                    <option value="24horas" class="options-filter">Nas últimas 24 horas</option>
                                    <option value="Hoje" class="options-filter">Hoje</option>
                                    <option value="Ontem" class="options-filter">Ontem</option>
                                    <option value="EstaSemana" class="options-filter">Esta semana</option>
                                    <option value="EsteMes" class="options-filter">Este mês</option>
                                    <option value="7dias" class="options-filter">Nos últimos 7 dias</option>
                                    <option value="30dias" class="options-filter">Nos últimos 30 dias</option>
                                    <option value="60dias" class="options-filter">Nos últimos 60 dias</option>
                                    <option value="180dias" class="options-filter">Nos últimos 180 dias</option>
                                </select>
                            </div>
                        </div> 
                        <div class="container mt-3">
                            <span class="filter-title-itens">Resolvido em</span>
                            <div class="multi-select-input" id="multiSelectInputResolvido">
                                <select id="ResolvidoSelect" name="resolvidoEm" class="select-input form-select" aria-label="Select Tipo Chamado">
                                    <option value="" class="options-filter">Qualquer hora</option>
                                    <option value="5min" class="options-filter">Nos últimos 5 minutos</option>
                                    <option value="15min" class="options-filter">Nos últimos 15 minutos</option>
                                    <option value="30min" class="options-filter">Nos últimos 30 minutos</option>
                                    <option value="1hora" class="options-filter">Na última hora</option>
                                    <option value="4horas" class="options-filter">Nas últimas 4 horas</option>
                                    <option value="12horas" class="options-filter">Nas últimas 12 horas</option>
                                    <option value="24horas" class="options-filter">Nas últimas 24 horas</option>
                                    <option value="Hoje" class="options-filter">Hoje</option>
                                    <option value="Ontem" class="options-filter">Ontem</option>
                                    <option value="EstaSemana" class="options-filter">Esta semana</option>
                                    <option value="EsteMes" class="options-filter">Este mês</option>
                                    <option value="7dias" class="options-filter">Nos últimos 7 dias</option>
                                    <option value="30dias" class="options-filter">Nos últimos 30 dias</option>
                                    <option value="60dias" class="options-filter">Nos últimos 60 dias</option>
                                    <option value="180dias" class="options-filter">Nos últimos 180 dias</option>
                                </select>
                            </div>
                        </div> 
                        <div class="container mt-3">
                            <span class="filter-title-itens">Resolução vence em</span>
                            <div class="multi-select-input" id="multiSelectInputVence">
                                <select id="VenceSelect" name="venceEm" class="select-input form-select" aria-label="Select Tipo Chamado">
                                    <option value="" class="options-filter">Qualquer hora</option>
                                    <option value="5min" class="options-filter">Nos últimos 5 minutos</option>
                                    <option value="15min" class="options-filter">Nos últimos 15 minutos</option>
                                    <option value="30min" class="options-filter">Nos últimos 30 minutos</option>
                                    <option value="1hora" class="options-filter">Na última hora</option>
                                    <option value="4horas" class="options-filter">Nas últimas 4 horas</option>
                                    <option value="12horas" class="options-filter">Nas últimas 12 horas</option>
                                    <option value="24horas" class="options-filter">Nas últimas 24 horas</option>
                                    <option value="Hoje" class="options-filter">Hoje</option>
                                    <option value="Ontem" class="options-filter">Ontem</option>
                                    <option value="EstaSemana" class="options-filter">Esta semana</option>
                                    <option value="EsteMes" class="options-filter">Este mês</option>
                                    <option value="7dias" class="options-filter">Nos últimos 7 dias</option>
                                    <option value="30dias" class="options-filter">Nos últimos 30 dias</option>
                                    <option value="60dias" class="options-filter">Nos últimos 60 dias</option>
                                    <option value="180dias" class="options-filter">Nos últimos 180 dias</option>
                                </select>
                            </div>
                        </div> 
                            <div class="container">
                                <button class="filter-button btn app-btn-secondary"  type="submit">Aplicar</button> 
                            </div>
                        </div>
                        
                    </div>
                    </div>
                </form>
            </div>
        </div>
            
        </div>
    </div>
    <script src="/static/js/request.js"></script>				
    <script>
        function toggleStatusCheckBox(checkbox) {
        // Encontre o elemento pai mais próximo com a classe 'row.ticket-chamado-background'
        var card = checkbox.closest('.row.ticket-chamado-background');
        
        if (checkbox.checked) {
            card.classList.add('checked');
        } else {
            card.classList.remove('checked');
        }
    }

    // const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    // const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))


    // Função para adicionar a opção selecionada
    function addSelectedOption(selectId, containerId, hiddenInputId) {
        const select = document.getElementById(selectId);
        const container = document.getElementById(containerId);
        const hiddenInput = document.getElementById(hiddenInputId);
        
        select.addEventListener('change', function() {
            const selectedValue = select.value;
            const selectedText = select.options[select.selectedIndex].text;
            const selectedId = select.options[select.selectedIndex].getAttribute('data-id'); 


            if (!selectedValue) return; // Ignore if no value is selected

            // Verifica se a opção já foi adicionada
            if (!document.querySelector(`#${containerId} [data-value="${selectedValue}"]`)) {
                const selectedOptionElement = document.createElement('div');
                selectedOptionElement.className = 'selected-option';
                selectedOptionElement.setAttribute('data-value', selectedValue);
                hiddenInput.value += select.value + ';'
                selectedOptionElement.setAttribute('data-id', selectedId);
                selectedOptionElement.innerHTML = `${selectedText} <button onclick="removeOption('${selectedValue}', '${containerId}')">&times;</button>`;

                container.insertBefore(selectedOptionElement, select);
            }

            // Reseta o select
            select.value = '';
        });
    }

    // Função para remover a opção
        function removeOption(value, containerId) {
            const container = document.getElementById(containerId);
            const optionElement = container.querySelector(`[data-value="${value}"]`);
            let hiddenInputRemove = document.getElementById('id_agentes');
            valores = hiddenInputRemove.value
            console.log(valores)
            valores = valores.replace(value+';', '')
            console.log(valores)
            if (optionElement) {
                container.removeChild(optionElement);
                hiddenInputRemove.value = valores
            }
            // hiddenInputRemove.value = ''
        }
        
        // Função para obter todos os valores e IDs das opções selecionadas
        function getSelectedOptions(containerId) {
            const container = document.getElementById(containerId);
            const selectedOptions = [];
            
            container.querySelectorAll('.selected-option').forEach(optionElement => {
                const value = optionElement.getAttribute('data-value');
                const id = optionElement.getAttribute('data-id');
                selectedOptions.push({ value, id });
            });

            return selectedOptions;
        }

    // Inicialize as funções para os selects
    addSelectedOption('agentesSelect', 'multiSelectInputAgentes', 'id_agentes');
    addSelectedOption('statusSelect', 'multiSelectInputStatus','id_status');
    addSelectedOption('tiposChamadosSelect', 'multiSelectInputTiposChamados', 'id_chamados');
    addSelectedOption('PrioridadeSelect', 'multiSelectInputPrioridade', 'id_prioridade')

    function hiddenMenuFilters() {
        var button = document.getElementById('mButtonFilters');
        var cardsWrapper = document.getElementById('cards-wrapper');
        var filtersWrapper = document.getElementById('offcanvasScrolling');
        
        if (window.matchMedia("(min-width: 768px)").matches) {
            if (button.style.marginRight === '250px') {
                // Voltar o botão para a posição original
                button.style.marginRight = '0px';
                cardsWrapper.style.paddingRight = '0px';
                button.innerHTML = '<i class="fa-solid fa-angle-left"></i>Filtros';
                filtersWrapper.classList.remove('active');
            } else {
                // Mover o botão para a esquerda em 250px
                button.style.marginRight = '250px';
                cardsWrapper.style.paddingRight = '250px';
                button.innerHTML = '<i class="fa-solid fa-angle-right"></i>Filtros';
                filtersWrapper.classList.add('active');
            }
        }
        else{
            if (filtersWrapper.classList.contains('active')) {
                filtersWrapper.classList.remove('active');
            } else {
                filtersWrapper.classList.add('active');
            }
        }
    }

    function saveOptionsFilter() {
        event.preventDefault(); // Evita o comportamento padrão de envio do formulário

        // Dicionário para armazenar as seleções
        let dados = {};

        // Seleciona todos os selects
        const selects = document.querySelectorAll('select');

        // Itera sobre todos os selects
        selects.forEach(select => {
            const selecionados = Array.from(select.selectedOptions).map(option => option.value);
            // Adiciona ao dicionário apenas se houver uma seleção
            if (selecionados.length > 0 && selecionados[0] !== "") {
                dados[select.id] = selecionados;
            }
        });

        // Verifica no console o resultado final
        console.log(dados);
        
        // Aqui você pode enviar o `dados` para o servidor ou utilizá-lo conforme necessário
        // Exemplo: enviar via AJAX, etc.
    }
    
    function mudar_status_select(id, display_status){
        let selectStatus = document.getElementById('statusSelect-'+id);
        selectStatus.innerText = display_status;   
        let indicadorStatus = document.getElementById('indicadorStatus-'+id);
        if (display_status == 'Em atendimento'){
            indicadorStatus.className = 'prioridade-indicador status-atendimento'
        }else{
            indicadorStatus.className = 'prioridade-indicador status-'+display_status.toLowerCase();
        }
        
        let card = document.getElementById('chamado-'+id);
        if (display_status.toLowerCase() == 'finalizado'){
            card.classList.add('card-status-finalizado');
        }else{            
            if (card.classList.contains('card-status-finalizado')) {
                card.classList.remove('card-status-finalizado');
            }
        }
    }
    function mudar_prioridade_select(id, display_prioridade){
        let selectPrioridade = document.getElementById('selectPrioridade-'+id);
        selectPrioridade.innerText = display_prioridade;   
        let indicadorPrioridade = document.getElementById('indicadorPrioridade-'+id);
        if (display_prioridade == 'Média'){
            indicadorPrioridade.className = 'prioridade-indicador prioridade-media'
        }else{
            indicadorPrioridade.className = 'prioridade-indicador prioridade-'+display_prioridade.toLowerCase();
        }        
    }
    function mudar_status(hash, status){
        
        var url = "{% url 'chamados:api_status' %}"; 
        formData = new FormData();
        formData.append('hash', hash);
        formData.append('status', status);
        formData.append('csrfmiddlewaretoken', '{{csrf_token}}');
		postRequest(url, formData)
							.then(response => {
                                if (response.status == 200){
                                    alert(response.message +" (" + response.status+")")
                                    mudar_status_select(response.id, response.display_status)
                                }else{
                                    alert(response.message +" (" + response.status+")")
                                }                                   
							})
							.catch(error => {
                                alert('Erro ao mudar status. Tente novamente mais tarde.')
								console.error(error)
							});				
    }
    function mudar_prioridade(hash, prioridade){
        var url = "{% url 'chamados:api_prioridade' %}"; 
        formData = new FormData();
        formData.append('hash', hash);
        formData.append('prioridade', prioridade);
        formData.append('csrfmiddlewaretoken', '{{csrf_token}}');
		postRequest(url, formData)
							.then(response => {
                                if (response.status == 200){
                                    // alert(response.message +" (" + response.status+")")
                                    mudar_prioridade_select(response.id, response.display_prioridade)
                                }else{
                                    alert(response.message +" (" + response.status+")")
                                }                                   
							})
							.catch(error => {
                                alert('Erro ao mudar status. Tente novamente mais tarde.')
								console.error(error)
							});				
    }
        </script>

{% endblock %}
