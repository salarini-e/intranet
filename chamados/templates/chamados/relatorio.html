
{% extends 'template_chamados.html' %}
{% block chamados %}active{% endblock %}
{% block title %}Tickets Chamados{% endblock %}
{% block css %}
<link rel="stylesheet" href="/static/css/tickets.css">
{% endblock %}
{% block main %}  
{% load custom_filters %}    
    <div class="row g-3 mb-4 align-items-center justify-content-between">
        
        <div class="col-auto">
            <h1 class="app-page-title tickets mb-0">Relatório</h1>          
        </div>
        {% if request.user.is_superuser or is_atendente%}
        <div class="col-auto col top-buttons-background">
            {% if is_atendente %}            
            <a href="{% url 'chamados:ordernarPorNaoFechados' %}" class="my-auto btn app-btn-secondary" data-bs-toggle="tooltip" data-bs-title="Baixar arquivo">
                <i class="fa-solid fa-file-arrow-down"></i>
            </a>            
            <a href="{% url 'chamados:tickets' %}" class="my-auto btn app-btn-secondary" data-bs-toggle="tooltip" data-bs-title="Voltar">
                <i class="fa-solid fa-rotate-left"></i>
            </a>            
            {% endif %}                                  
            <button class="my-auto btn p-4 py-2" id="mButtonFilters" 
                    data-bs-toggle="offcanvas" 
                    data-bs-target="#offcanvasScrolling" 
                    onclick="toggleMenuFilters()"
                    >
                <i class="fa-solid fa-angle-left"></i><i class="fa-solid fa-filter mx-2"></i>Filtros
            </button>
        </div>
        {% endif %}
    </div>
    {% if is_atendente %}
    <div id="menuAcoes" class="row hiddenAction">
        <div class="col pb-3 d-flex" style="padding-right: 265px;">
            <select onchange="realizarAcao()" name="acoes" id="acoes" class="form-select me-2 my-auto">
                <option value="" selected disabled>Selecione uma ação</option>                
                <option value="mesclar">Mesclar chamados</option>                
            </select>           
        </div>
    </div>
    {% endif %}
    <!-- CARDS -->
    <div class="container">
        
        <div class="row">
            <!-- Coluna de 9 colunas -->
            <div class="col-lg-12" id="cards-wrapper" >
                <div id="indicativo-atualizacao" class="list-atualizacoes" onclick="recarregarPagina()" >
                </div>
                {% if messages %}
						<div class="alert alert-dismissible shadow-sm bg-success border-left-decoration" role="alert" id="createTicketAlert" style="margin-left: -0.75rem; margin-right: 0.75rem;">
							<div class="inner">
								<div class="app-card-body px-3 px-lg-4">						    
									<div class="row gx-5 gy-3">
										<div class="col-12 col">
											<div class="text-light" style="color: white;">
											{% for message in messages %}
											{{message}}
											{% endfor %}
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
	            {% endif %}
                <div class="row">
                    <div class="app-card p-5 col" id="print">
                        <div class="row">
                            <div class="col">
                                <h1>Total de Chamados: {{ total_chamados }}</h1>

                            </div>                            
                        </div>
        
                        <div class="row my-4 text-center">
                            <div class="col">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Abertos</h5>
                                        <p class="card-text">{{chamados_por_status.0}}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Pendentes</h5>
                                        <p class="card-text">{{chamados_por_status.2}}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Fechados</h5>
                                        <p class="card-text">{{chamados_por_status.4}}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Cancelados</h5>
                                        <p class="card-text">{{chamados_por_status.5}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">                                
                                <div class="row pt-3">
                                    <div class="col-4">
                                        <div class="row">
                                            <div class="col d-flex">
                                                <h4>Chamados por tipo</h4>
                                                <button onclick="openModal('modalGrafPorTipo')" class="ms-auto border-0 my-auto btn app-btn-secondary">
                                                    <i class="fa-solid fa-magnifying-glass-chart"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col">                                                
                                                {% for item in chamados_por_tipo %}
                                                <div class="d-flex w-100">
                                                    <span>{{ item.tipo__nome }}</span>
                                                    <span class="ms-auto">
                                                        {{ item.total }}
                                                        <button class="ms-2 border-0 btn app-btn-secondary" style="background-color: #5d677800;">
                                                            <i class="fa-solid fa-binoculars"></i>
                                                        </button>
                                                    </span>
                                                    
                                                </div>
                                                {% endfor %}                                        
                                            </div>
                                        </div>
                                                                                                                    
                                    </div>   
                                    <div class="col-8">
                                        <table class="table table-striped table-bordered">
                                            <thead>
                                                {% for item in chamados_por_tipo %}
                                                <th>{{item.tipo__nome}}</th>
                                                {% endfor %}
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    {% for item in chamados_por_tipo %}
                                                    <td>{{item.tipo__nome|total_subtipo}}</td>
                                                    {% endfor %}                                                    
                                                </tr>                                                
                                            </tbody>
                                        </table>
                                    </div>                                 
                                </div>
                                <div class="row">
                                    ué
                                </div>                                
                            </div>                            
                        </div>
                        <div class="row">
                            <div class="col-6">                                
                                <canvas id="canvas-chart4" ></canvas>
                            </div>
                            <div class="col-6">                                
                                <div class="chart-container">
                                    <canvas id="canvas-chart1" ></canvas>
                                </div>
                                
                            </div>
                        </div>
                        <div class="row">
                            
                            <div class="col-6">
                                <div class="chart-container">
                                    <canvas id="canvas-chart2" ></canvas>
                                </div>
                            </div>
                            <div class="col-6">
                            </div>
                        </div>                        
                        
                        
                        <h4>Chamados por Prioridade</h4>
                        <ul>
                            {% for prioridade in chamados_por_prioridade %}
                                <li>{{ prioridade.prioridade }}: {{ prioridade.total }}</li>
                            {% endfor %}
                        </ul>
                
                        <h4>Tempo Médio de Resolução</h4>
                        <p>{{ tempo_medio_resolucao|default:"Não disponível" }}</p>
                
                        <h4>Atendentes com Mais Chamados Atribuídos</h4>
                        <ul>
                            {% for atendente in atendentes_ativos %}
                                <li>{{ atendente.profissional_designado__nome_servidor }}: {{ atendente.total }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                
            </div>
            
            {% if request.user.is_superuser or is_atendente%}
            <div style="margin-top: 53px; z-index: 10; width: 280px; background-color: #f5f5f5;" 
                class="offcanvas offcanvas-end filters-wrapper" 
                data-bs-scroll="true" data-bs-backdrop="false" 
                tabindex="-1" id="offcanvasScrolling" 
                aria-labelledby="offcanvasScrollingLabel">

            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasScrollingLabel">Filtros</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" onclick="toggleMenuFilters()"></button>
            </div>
            <!-- FILTRO -->
            <div class="offcanvas-body">
                <form method="POST" class="row" id="filter-form">
                    <div class="col">
                        {% csrf_token %}	
                        <!-- AGENTES -->
                        <div class="container" id="container-agentes">
                            <span class="filter-title-itens">Agentes incluem</span>
                            <div class="multi-select-input form-select" id="multiSelectInputAgentes">
                                {% if request.session.agentes %}
                                {% for agente in  request.session.agentes %}
                                <div class="selected-option id_agentesOptions" data-value="{{agente.id}}">{{agente.nome}} <button onclick="removeOption('{{agente.id}}', 'multiSelectInputAgentes', 'id_agentes')">×</button></div>
                                {% endfor %}
                                {% endif %}
                                <input class="input-hidden-values" type="hidden" name="agentes" id="id_agentes" {% if request.session.agentes %}value='{% for agente in  request.session.agentes %}{{agente.id}};{%endfor%}'{% endif %}>
                                <select id="agentesSelect" class="select-input form-select" aria-label="Select Agentes" data-id="id_agentes">
                                    <option value="" class="options-filter"></option>
                                    {% for atendente in atendentes %}
                                    <option value="{{ atendente.id }}" class="options-filter" {% if atendente.id|stringformat:"s" in agentes_selecionados %}selected{% endif %}>
                                        {{ atendente.nome_servidor }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>	
                        <!-- SECRETARIAS -->
                        <!-- <div class="container mt-3" id="container-secretaria">
                            <span class="filter-title-itens">Secretaria incluem</span>
                            <div class="multi-select-input form-select" id="multiSelectInputSecretarias">
                                {% if request.session.secretarias %}
                                {% for secretaria in  request.session.secretarias %}
                                <div class="selected-option id_secretariasOptions" data-value="{{secretaria.id}}">{{secretaria.apelido}} <button onclick="removeOption('{{secretaria.id}}', 'multiSelectInputSecretarias', 'id_secretaria')">×</button></div>
                                {% endfor %}
                                {% endif %}
                                <input class="input-hidden-values" type="hidden" name="secretarias" id="id_secretarias" {% if request.session.secretaria %}value='{% for secretaria in  request.session.secretarias %}{{secretaria.id}};{%endfor%}'{% endif %}>
                                <select id="secretariasSelect" class="select-input form-select" aria-label="Select Secretarias" data-id="id_secretarias">
                                    <option value="" class="options-filter"></option>
                                    {% for secretaria in secretarias %}
                                    <option value="{{ secretaria.id }}" class="options-filter" {% if secretaria.id|stringformat:"s" in secretarias_selecionados %}selected{% endif %}>
                                        {{ secretaria.apelido }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>	 -->
                        <!-- STATUS -->
                        <div class="container mt-3" id="container-status">
                            <span class="filter-title-itens">Status incluem</span>
                            <div class="multi-select-input form-select" id="multiSelectInputStatus">
                                {% if request.session.status %}
                                {% for status in request.session.status %}
                                <div class="selected-option id_statusOptions" data-value="{{status.id}}">{{status.nome}} <button onclick="removeOption('{{status.id}}', 'multiSelectInputStatus','id_status')">×</button></div>
                                {% endfor %}
                                {% endif %}
                                <input type="hidden" name="status" id="id_status" {% if request.session.status %}value='{% for status in request.session.status %}{{status.id}};{% endfor %}'{% endif %}>
                                <select id="statusSelect" class="select-input form-select" aria-label="Select Status" data-id="id_status">
                                    <option value="" class="options-filter"></option>
                                    {% for status in status_choices%}
                                    <option value="{{status.0}}" class="options-filter" {% if status.0|stringformat:"s" in status_selecionados %}selected{% endif %}>
                                        {{status.1}}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- TIPOS CHAMADOS -->
                        <div class="container mt-3" id="container-grupos">
                            <span class="filter-title-itens">Grupos incluem</span>
                            <div class="multi-select-input form-select" id="multiSelectInputTiposChamados">
                                {% if request.session.tiposChamados %}
                                {% for tipochamado in request.session.tiposChamados %}
                                <div class="selected-option id_tiposChamadosOptions" data-value="{{tipochamado.id}}">{{tipochamado.nome}} 
                                    <button onclick="removeOption('{{tipochamado.id}}', 'multiSelectInputTiposChamados', 'id_tiposChamados')">×</button>
                                </div>
                                {% endfor %}
                                {% endif %}
                                <input type="hidden" name="tiposChamados" id="id_tiposChamados" {% if request.session.tiposChamados %}value='{% for tipochamado in request.session.tiposChamados %}{{tipochamado.id}};{% endfor %}'{% endif %}>
                                <select id="tiposChamadosSelect" class="select-input form-select" aria-label="Select Tipo Chamado" data-id="id_tiposChamados">
                                    <option value="" class="options-filter"></option>
                                    {% for tipochamado in tipos_chamados %}
                                    <option value="{{tipochamado.id}}" class="options-filter" {% if tipochamado.id|stringformat:"s" in tiposChamados_selecionados %}selected{% endif %}>
                                        {{tipochamado.nome}}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- PRIORIDADE -->
                        <div class="container mt-3" id="container-prioridades">
                            <span class="filter-title-itens">Prioridades incluem</span>
                            <div class="multi-select-input form-select" id="multiSelectInputPrioridade">
                                {% if request.session.prioridade %}
                                {% for prioridade in request.session.prioridade %}
                                <div class="selected-option id_prioridadeOptions" data-value="{{prioridade.id}}">{{prioridade.nome}} 
                                    <button onclick="removeOption('{{prioridade.id}}', 'multiSelectInputPrioridade', 'id_prioridade')">×</button>
                                </div>
                                {% endfor %}
                                {% endif %}
                                <input type="hidden" name="prioridade" id="id_prioridade" {% if request.session.prioridade %}value='{% for prioridade in request.session.prioridade %}{{prioridade.id}};{% endfor %}'{% endif %}>
                                <select id="PrioridadeSelect" class="select-input form-select" aria-label="Select Prioridade" data-id="id_prioridade">
                                    <option value="" class="options-filter"></option>
                                    {% for prioridade in prioridade_choices %}
                                    <option value="{{prioridade.0}}" class="options-filter">{{prioridade.1}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>                        
                        <div class="container mt-3">
                            <span class="filter-title-itens">Secretaria</span>
                            <div class="multi-select-input" id="multiSelectInputResolvido">
                                <select id="agendadoPara" name="agendadoPara" class="select-input form-select" aria-label="Select Tipo Chamado">
                                    <option value="" class="options-filter" {% if request.session.agendadoPara == ''  %}selected{% endif %}></option>
                                    {% for secretaria in secretarias %}
                                    <option value="{{ secretaria.id }}" class="options-filter" {% if secretaria.id|stringformat:"s" == request.session.agendadoPara|stringformat:"s" %}selected{% endif %}>
                                        {{ secretaria.apelido }}
                                    {% endfor %}
                                    <!-- <option value="5min" class="options-filter" {% if request.session.agendadoPara == '5min'  %}selected{% endif %}>Nos últimos 5 minutos</option>
                                    <option value="15min" class="options-filter" {% if request.session.agendadoPara == '15min'  %}selected{% endif %}>Nos últimos 15 minutos</option>
                                    <option value="30min" class="options-filter" {% if request.session.agendadoPara == '30min'  %}selected{% endif %}>Nos últimos 30 minutos</option>
                                    <option value="1hora" class="options-filter" {% if request.session.agendadoPara == '1hora'  %}selected{% endif %}>Na última hora</option>
                                    <option value="4horas" class="options-filter" {% if request.session.agendadoPara == '4horas'  %}selected{% endif %}>Nas últimas 4 horas</option>
                                    <option value="12horas" class="options-filter" {% if request.session.agendadoPara == '12horas'  %}selected{% endif %}>Nas últimas 12 horas</option>
                                    <option value="24horas" class="options-filter" {% if request.session.agendadoPara == '24horas'  %}selected{% endif %}>Nas últimas 24 horas</option>
                                    <option value="Hoje" class="options-filter" {% if request.session.agendadoPara == 'Hoje'  %}selected{% endif %}>Hoje</option>
                                    <option value="Ontem" class="options-filter" {% if request.session.agendadoPara == 'Ontem'  %}selected{% endif %}>Ontem</option>
                                    <option value="EstaSemana" class="options-filter" {% if request.session.agendadoPara == 'EstaSemana'  %}selected{% endif %}>Esta semana</option>
                                    <option value="EsteMes" class="options-filter" {% if request.session.agendadoPara == 'EsteMes'  %}selected{% endif %}>Este mês</option>
                                    <option value="7dias" class="options-filter" {% if request.session.agendadoPara == '7dias'  %}selected{% endif %}>Nos últimos 7 dias</option>
                                    <option value="30dias" class="options-filter" {% if request.session.agendadoPara == '30dias'  %}selected{% endif %}>Nos últimos 30 dias</option>
                                    <option value="60dias" class="options-filter" {% if request.session.agendadoPara == '60dias'  %}selected{% endif %}>Nos últimos 60 dias</option>
                                    <option value="180dias" class="options-filter" {% if request.session.agendadoPara == '180dias'  %}selected{% endif %}>Nos últimos 180 dias</option> -->
                                </select>
                            </div>
                        </div> 
                        <div class="container mt-3">
                            <span class="filter-title-itens">Atualização em</span>
                            <div class="multi-select-input" id="multiSelectInputVence">
                                <select id="atualizacaoEm" name="atualizacaoEm" class="select-input form-select" aria-label="Select Tipo Chamado">
                                    <option value="" class="options-filter" {% if request.session.atualizacaoEm == ''  %}selected{% endif %}></option>
                                    <option value="5min" class="options-filter" {% if request.session.atualizacaoEm == '5min'  %}selected{% endif %}>Nos últimos 5 minutos</option>
                                    <option value="15min" class="options-filter" {% if request.session.atualizacaoEm == '15min'  %}selected{% endif %}>Nos últimos 15 minutos</option>
                                    <option value="30min" class="options-filter" {% if request.session.atualizacaoEm == '30min'  %}selected{% endif %}>Nos últimos 30 minutos</option>
                                    <option value="1hora" class="options-filter" {% if request.session.atualizacaoEm == '1hora'  %}selected{% endif %}>Na última hora</option>
                                    <option value="4horas" class="options-filter" {% if request.session.atualizacaoEm == '4horas'  %}selected{% endif %}>Nas últimas 4 horas</option>
                                    <option value="12horas" class="options-filter" {% if request.session.atualizacaoEm == '12horas'  %}selected{% endif %}>Nas últimas 12 horas</option>
                                    <option value="24horas" class="options-filter" {% if request.session.atualizacaoEm == '24horas'  %}selected{% endif %}>Nas últimas 24 horas</option>
                                    <option value="Hoje" class="options-filter" {% if request.session.atualizacaoEm == 'Hoje'  %}selected{% endif %}>Hoje</option>
                                    <option value="Ontem" class="options-filter" {% if request.session.atualizacaoEm == 'Ontem'  %}selected{% endif %}>Ontem</option>
                                    <option value="EstaSemana" class="options-filter" {% if request.session.atualizacaoEm == 'EstaSemana'  %}selected{% endif %}>Esta semana</option>
                                    <option value="EsteMes" class="options-filter" {% if request.session.atualizacaoEm == 'EsteMes'  %}selected{% endif %}>Este mês</option>
                                    <option value="7dias" class="options-filter" {% if request.session.atualizacaoEm == '7dias'  %}selected{% endif %}>Nos últimos 7 dias</option>
                                    <option value="30dias" class="options-filter" {% if request.session.atualizacaoEm == '30dias'  %}selected{% endif %}>Nos últimos 30 dias</option>
                                    <option value="60dias" class="options-filter" {% if request.session.atualizacaoEm == '60dias'  %}selected{% endif %}>Nos últimos 60 dias</option>
                                    <option value="180dias" class="options-filter" {% if request.session.atualizacaoEm == '180dias'  %}selected{% endif %}>Nos últimos 180 dias</option>
                                </select>
                            </div>
                        </div>                         
                        <div class="container mt-3">
                            <p class="pb-0"><strong>Filtrar período</strong></p>
                            <span class="filter-title-itens">Início</span>
                            <div class="multi-select-input" id="multiSelectInputCriado">
                                <input value="{{request.session.criadoEm}}" type="date" class="form-control" name="criadoEm" id="criadoEm">
                                <!-- <select id="criadoEm" name="criadoEm" class="select-input form-select id_criadoEmOptions" aria-label="Select Tipo Chamado">  
                                    <option value="" class="options-filter" {% if request.session.criadoEm == ''  %}selected{% endif %}></option>
                                    <option value="5min" class="options-filter" {% if request.session.criadoEm == '5min'  %}selected{% endif %}>Nos últimos 5 minutos</option>
                                    <option value="15min" class="options-filter" {% if request.session.criadoEm == '15min'  %}selected{% endif %}>Nos últimos 15 minutos</option>
                                    <option value="30min" class="options-filter" {% if request.session.criadoEm == '30min'  %}selected{% endif %}>Nos últimos 30 minutos</option>
                                    <option value="1hora" class="options-filter" {% if request.session.criadoEm == '1hora'  %}selected{% endif %}>Na última hora</option>
                                    <option value="4horas" class="options-filter" {% if request.session.criadoEm == '4horas'  %}selected{% endif %}>Nas últimas 4 horas</option>
                                    <option value="12horas" class="options-filter" {% if request.session.criadoEm == '12horas'  %}selected{% endif %}>Nas últimas 12 horas</option>
                                    <option value="24horas" class="options-filter" {% if request.session.criadoEm == '24horas'  %}selected{% endif %}>Nas últimas 24 horas</option>
                                    <option value="Hoje" class="options-filter" {% if request.session.criadoEm == 'Hoje'  %}selected{% endif %}>Hoje</option>
                                    <option value="Ontem" class="options-filter" {% if request.session.criadoEm == 'Ontem'  %}selected{% endif %}>Ontem</option>
                                    <option value="EstaSemana" class="options-filter" {% if request.session.criadoEm == 'EstaSemana'  %}selected{% endif %}>Esta semana</option>
                                    <option value="EsteMes" class="options-filter" {% if request.session.criadoEm == 'EsteMes'  %}selected{% endif %}>Este mês</option>
                                    <option value="7dias" class="options-filter" {% if request.session.criadoEm == '7dias'  %}selected{% endif %}>Nos últimos 7 dias</option>
                                    <option value="30dias" class="options-filter" {% if request.session.criadoEm == '30dias'  %}selected{% endif %}>Nos últimos 30 dias</option>
                                    <option value="60dias" class="options-filter" {% if request.session.criadoEm == '60dias'  %}selected{% endif %}>Nos últimos 60 dias</option>
                                    <option value="180dias" class="options-filter" {% if request.session.criadoEm == '180dias'  %}selected{% endif %}>Nos últimos 180 dias</option>
                                </select> -->
                            </div>
                        </div> 
                        <div class="container mt-1">                            
                            <span class="filter-title-itens">Fim</span>
                            <div class="multi-select-input" id="multiSelectInputFechado">
                                <input value="{{request.session.fechadoEm}}" type="date" name="fechadoEm" class="form-control" id="fechadoEm">
                                <!-- <select id="fechadoEm" name="fechadoEm" class="select-input form-select" aria-label="Select Tipo Chamado">
                                    <option value="" class="options-filter" {% if request.session.fechadoEm == ''  %}selected{% endif %}></option>
                                    <option value="5min" class="options-filter" {% if request.session.fechadoEm == '5min'  %}selected{% endif %}>Nos últimos 5 minutos</option>
                                    <option value="15min" class="options-filter" {% if request.session.fechadoEm == '15min'  %}selected{% endif %}>Nos últimos 15 minutos</option>
                                    <option value="30min" class="options-filter" {% if request.session.fechadoEm == '30min'  %}selected{% endif %}>Nos últimos 30 minutos</option>
                                    <option value="1hora" class="options-filter" {% if request.session.fechadoEm == '1hora'  %}selected{% endif %}>Na última hora</option>
                                    <option value="4horas" class="options-filter" {% if request.session.fechadoEm == '4horas'  %}selected{% endif %}>Nas últimas 4 horas</option>
                                    <option value="12horas" class="options-filter" {% if request.session.fechadoEm == '12horas'  %}selected{% endif %}>Nas últimas 12 horas</option>
                                    <option value="24horas" class="options-filter" {% if request.session.fechadoEm == '24horas'  %}selected{% endif %}>Nas últimas 24 horas</option>
                                    <option value="Hoje" class="options-filter" {% if request.session.fechadoEm == 'Hoje'  %}selected{% endif %}>Hoje</option>
                                    <option value="Ontem" class="options-filter" {% if request.session.fechadoEm == 'Ontem'  %}selected{% endif %}>Ontem</option>
                                    <option value="EstaSemana" class="options-filter" {% if request.session.fechadoEm == 'EstaSemana'  %}selected{% endif %}>Esta semana</option>
                                    <option value="EsteMes" class="options-filter" {% if request.session.fechadoEm == 'EsteMes'  %}selected{% endif %}>Este mês</option>
                                    <option value="7dias" class="options-filter" {% if request.session.fechadoEm == '7dias'  %}selected{% endif %}>Nos últimos 7 dias</option>
                                    <option value="30dias" class="options-filter" {% if request.session.fechadoEm == '30dias'  %}selected{% endif %}>Nos últimos 30 dias</option>
                                    <option value="60dias" class="options-filter" {% if request.session.fechadoEm == '60dias'  %}selected{% endif %}>Nos últimos 60 dias</option>
                                    <option value="180dias" class="options-filter" {% if request.session.fechadoEm == '180dias'  %}selected{% endif %}>Nos últimos 180 dias</option>
                                </select> -->
                            </div>
                        </div> 
                        <!-- <div class="container mt-3">
                            <p class="mb-0 pb-0"><strong>Período</strong></p>

                            <span class="filter-title-itens">Inicial</span>
                            <div class="multi-select-input">
                            <input class="form-control" type="date" name="" id="">
                            </div>
                            <span class="filter-title-itens">Final</span>
                            <div class="multi-select-input">
                            <input class="form-control" type="date" name="" id="">
                            </div>
                            
                        </div>  -->
                            <div class="container">
                                <button class="filter-button btn app-btn-primary"  type="submit"><i class="fa-solid fa-filter me-2"></i>Aplicar</button> 
                                <button class="filter-button btn app-btn-secondary"  type="button" onclick="clearInputs()"><i class="fa-solid fa-filter-circle-xmark me-2"></i>Limpar filtros</button> 
                            </div>
                        </div>
                        
                    </div>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
        
        </div>
    </div>
    <style>
    .hiddenAction {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-out;
    }

    .showAction {
        max-height: 500px; /* Defina um valor maior que a altura máxima do conteúdo */
        overflow: hidden;
        transition: max-height 0.5s ease-in;
    }

    </style>
    <script src="/static/js/request.js"></script>	
    <script src="/static/plugins/chart.js/chart.min.js"></script> 
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>			
    <script>
    window.chartColors = {
        abertos: '#1db062', // rgba(117,193,129, 1)
        pendentes: '#FFDB58', // rgba(255,219,88, 1)
        fechados: '#808080', // rgba(128,128,128, 1)
        cancelados: '#ff0000',
        text: '#252930',
        border: '#e7e9ed'
    };
    var randomDataPoint = function(){ return Math.round(Math.random()*100)};

    function barChartConfig(labels, data, legend_value) {
        return {
            type: 'bar',

            data: {
                labels: labels,
                datasets: [{
                    label: 'Dataset 1',
                    backgroundColor: "rgba(117,193,129,0.8)", 
                    hoverBackgroundColor: "rgba(117,193,129,1)",
                    
                    
                    data: data
                },                 
                ]
            },
            options: {
                responsive: true,
                legend: {
                    display: legend_value,
                    position: 'bottom',
                    align: 'end',
                },

                tooltips: {
                    mode: 'index',
                    intersect: false,
                    titleMarginBottom: 10,
                    bodySpacing: 10,
                    xPadding: 16,
                    yPadding: 16,
                    borderColor: window.chartColors.border,
                    borderWidth: 1,
                    backgroundColor: '#fff',
                    bodyFontColor: window.chartColors.text,
                    titleFontColor: window.chartColors.text,
                    callbacks: {
                        label: function(tooltipItem, data) {	                 
                            return tooltipItem.value + '%';   
                        }
                    },
                    

                },
                scales: {
                    xAxes: [{
                        display: true,
                        gridLines: {
                            drawBorder: false,
                            color: window.chartColors.border,
                        },

                    }],
                    yAxes: [{
                        display: true,
                        gridLines: {
                            drawBorder: false,
                            color: window.chartColors.borders,
                        },
                        ticks: {
                            beginAtZero: true,
                            userCallback: function(value, index, values) {
                                return value + '%';  
                            }
                        },

                        
                    }]
                }
                
            }
        }
    }

    function pieChartConfig(labels, data, legend_value) {
            return {
                type: 'pie',
                data: {
                    datasets: [{
                        data: data, // Recebe o parâmetro
                        backgroundColor: [
                            window.chartColors.abertos,
                            window.chartColors.pendentes,
                            window.chartColors.fechados,
                            window.chartColors.cancelados,
                            'purple',
                            'orange'
                        ],
                        label: 'Dataset 1'
                    }],
                    labels: labels
                },
                options: {
                    responsive: true,
                    legend: {
                        display: legend_value,
                        position: 'bottom',
                        align: 'center',
                    },
                    tooltips: {
                        titleMarginBottom: 10,
                        bodySpacing: 10,
                        xPadding: 16,
                        yPadding: 16,
                        borderColor: window.chartColors.border,
                        borderWidth: 1,
                        backgroundColor: '#fff',
                        bodyFontColor: window.chartColors.text,
                        titleFontColor: window.chartColors.text,
                        callbacks: {
                            label: function(tooltipItem, data) {
                                var dataset = data.datasets[tooltipItem.datasetIndex];
                                var total = dataset.data.reduce((prev, curr) => prev + curr, 0);
                                var currentValue = dataset.data[tooltipItem.index];
                                var percentage = Math.floor(((currentValue / total) * 100) + 0.5);
                                return percentage + "%";
                            },
                        },
                    },
                }
            };
        }
    
    window.addEventListener('load', function(){
        labels_status = ['Abertos', 'Pendentes', 'Fechados', 'Cancelados']
        data_status = [{{chamados_por_status.0}}, {{chamados_por_status.2}}, {{chamados_por_status.4}}, {{chamados_por_status.5}}]
        labels_tipo = [{% for tipo in chamados_por_tipo %}"{{tipo.tipo__nome}}", {% endfor %}]
        data_tipo = [{% for tipo in chamados_por_tipo %}{{tipo.total}}, {% endfor %}]
        labels_bar = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho']
        data_bar = [randomDataPoint(), randomDataPoint(), randomDataPoint(), randomDataPoint(), randomDataPoint(), randomDataPoint(), randomDataPoint()]
        var pieChart = document.getElementById('canvas-chart1').getContext('2d');
        varpieChart2 = document.getElementById('canvas-chart2').getContext('2d');
        window.myPie = new Chart(pieChart, pieChartConfig(labels_status, data_status, false));
        window.myPie2 = new Chart(varpieChart2, pieChartConfig(labels_tipo, data_tipo, true));

        var barChart = document.getElementById('canvas-chart3').getContext('2d');
	    window.myBar = new Chart(barChart, barChartConfig(labels_tipo, data_tipo, false));
    });	

    
    // const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    // const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))


    // Função para adicionar a opção selecionada

    function addSelectedOption(selectId, containerId, hiddenInputId) {
        const select = document.getElementById(selectId);
        const container = document.getElementById(containerId);
        const hiddenInput = document.getElementById(hiddenInputId);
        
        select.addEventListener('change', function(e) {
            const selectedValue = select.value;
            const selectedText = select.options[select.selectedIndex].text;
            const selectedId = select.options[select.selectedIndex].getAttribute('data-id'); 
            
            if (!selectedValue) return; // Ignore if no value is selected
            
            // Verifica se a opção já foi adicionada
            if (!document.querySelector(`#${containerId} [data-value="${selectedValue}"]`)) {
                const selectedOptionElement = document.createElement('div');
                selectedOptionElement.className = `selected-option ${e.target.dataset.id}Options`;
                selectedOptionElement.setAttribute('data-value', selectedValue);
                hiddenInput.value += select.value + ';'
                selectedOptionElement.setAttribute('data-id', selectedId);
                selectedOptionElement.innerHTML = `${selectedText} <button onclick="removeOption('${selectedValue}', '${containerId}', '${e.target.dataset.id}')">&times;</button>`;
                container.insertBefore(selectedOptionElement, select);
            }

            // Reseta o select
            select.value = '';
        });
    }

    // Função para remover a opção
        // function removeInput(id)
        function removeOption(value, containerId, id_input) {
            const container = document.getElementById(containerId);
            const optionElement = container.querySelector(`[data-value="${value}"]`);
            let hiddenInput = document.getElementById(id_input);

            valoresAgentes = hiddenInput.value
            valoresAgentes = valoresAgentes.replace(value+';', '')
            if (optionElement) {
                container.removeChild(optionElement);
                hiddenInput.value = valoresAgentes
            }
            
        }
        
        // Função para obter todos os valores e IDs das opções selecionadas
        function getSelectedOptions(containerId) {
            const container = document.getElementById(containerId);
            const selectedOptions = [];
            
            container.querySelectorAll('.selected-option').forEach(optionElement => {
                const value = optionElement.getAttribute('data-value');
                const id = optionElement.getAttribute('data-id');
                selectedOptions.push({ value, id });
            });

            return selectedOptions;
        }

    // Inicialize as funções para os selects
    addSelectedOption('agentesSelect', 'multiSelectInputAgentes', 'id_agentes');
    addSelectedOption('statusSelect', 'multiSelectInputStatus','id_status');
    addSelectedOption('tiposChamadosSelect', 'multiSelectInputTiposChamados', 'id_tiposChamados');
    addSelectedOption('PrioridadeSelect', 'multiSelectInputPrioridade', 'id_prioridade');
    // addSelectedOption('secretariasSelect', 'multiSelectInputSecretarias', 'id_secretarias');
    function clearInputs(){
        ids = ['agentes', 'status', 'tiposChamados', 'prioridade']
        ids_selects = ['agendadoPara','atualizacaoEm']
        dates = ['criadoEm', 'fechadoEm'] 
        // parte para limpar os selects multiplos
        ids.forEach(id => {
            document.getElementById('id_'+id).value = ''
            opcoesDiv = document.querySelectorAll('.id_'+id+'Options')
            opcoesDiv.forEach(div =>
                {
                    div.remove()
                }
            )
            // console.log(opcoesDiv)
        });
        // parte para limpar os selects simples
        ids_selects.forEach(id_select => {
            const selectElement = document.getElementById(id_select);
            if (selectElement) {
                selectElement.selectedIndex = 0;  
            }
        });
        // parte para limpar os inputs de data
        dates.forEach(date => {
            document.getElementById(date).value = ''
        });
    }
    function hiddenMenuFilters() {
        var button = document.getElementById('mButtonFilters');
        var cardsWrapper = document.getElementById('cards-wrapper');
        var filtersWrapper = document.getElementById('offcanvasScrolling');

        if (window.matchMedia("(min-width: 768px)").matches) {
            filtersWrapper.classList.add('active', 'show');
            button.style.marginRight = '250px'; 
            cardsWrapper.style.paddingRight = '250px';
            button.innerHTML = '<i class="fa-solid fa-angle-right"></i><i class="fa-solid fa-filter mx-2"></i>Filtros';
        } else {
            filtersWrapper.classList.remove('active', 'show'); 
            button.style.marginRight = '0px'; 
            cardsWrapper.style.paddingRight = '0px'; 
            button.innerHTML = '<i class="fa-solid fa-angle-left"></i><i class="fa-solid fa-filter mx-2"></i>Filtros';
        }
    }

    function toggleMenuFilters() {
        var button = document.getElementById('mButtonFilters');
        var cardsWrapper = document.getElementById('cards-wrapper');
        var filtersWrapper = document.getElementById('offcanvasScrolling');

        if (window.matchMedia("(min-width: 768px)").matches) {
            // Telas grandes: alternar entre abrir e fechar
            if (filtersWrapper.classList.contains('active')) {
                button.style.marginRight = '0px'; 
                cardsWrapper.style.paddingRight = '0px'; 
                button.innerHTML = '<i class="fa-solid fa-angle-left"></i><i class="fa-solid fa-filter mx-2"></i>Filtros';
                filtersWrapper.classList.remove('active', 'show');
            } else {
                button.style.marginRight = '250px'; 
                cardsWrapper.style.paddingRight = '250px'; 
                button.innerHTML = '<i class="fa-solid fa-angle-right"></i><i class="fa-solid fa-filter mx-2"></i>Filtros';
                filtersWrapper.classList.add('active', 'show'); 
            }
        } else {
            if (filtersWrapper.classList.contains('active')) {
                filtersWrapper.classList.remove('active', 'show'); 
            } else {
                filtersWrapper.classList.add('active', 'show'); 
            }
        }
    }

    document.addEventListener('DOMContentLoaded', hiddenMenuFilters);
    window.addEventListener('resize', hiddenMenuFilters);

    function saveOptionsFilter() {
        event.preventDefault(); // Evita o comportamento padrão de envio do formulário

        // Dicionário para armazenar as seleções
        let dados = {};

        // Seleciona todos os selects
        const selects = document.querySelectorAll('select');

        // Itera sobre todos os selects
        selects.forEach(select => {
            const selecionados = Array.from(select.selectedOptions).map(option => option.value);
            // Adiciona ao dicionário apenas se houver uma seleção
            if (selecionados.length > 0 && selecionados[0] !== "") {
                dados[select.id] = selecionados;
            }
        });

    }
    
    function mudar_status_select(id, display_status){
        let selectStatus = document.getElementById('statusSelect-'+id);
        selectStatus.innerText = display_status;   
        let indicadorStatus = document.getElementById('indicadorStatus-'+id);
        if (display_status == 'Em atendimento'){
            indicadorStatus.className = 'prioridade-indicador status-atendimento'
        }else{
            indicadorStatus.className = 'prioridade-indicador status-'+display_status.toLowerCase();
        }
        
        let card = document.getElementById('chamado-'+id);
        if (display_status.toLowerCase() == 'finalizado'){
            card.classList.add('card-status-finalizado');
        }else{            
            if (card.classList.contains('card-status-finalizado')) {
                card.classList.remove('card-status-finalizado');
            }
        }
    }
    function mudar_prioridade_select(id, display_prioridade){
        let selectPrioridade = document.getElementById('selectPrioridade-'+id);
        selectPrioridade.innerText = display_prioridade;   
        let indicadorPrioridade = document.getElementById('indicadorPrioridade-'+id);
        if (display_prioridade == 'Média'){
            indicadorPrioridade.className = 'prioridade-indicador prioridade-media'
        }
        else if(display_prioridade ==  'Não definida'){
            indicadorPrioridade.className = 'prioridade-indicador prioridade-nao-definida'
        }
        else{
            indicadorPrioridade.className = 'prioridade-indicador prioridade-'+display_prioridade.toLowerCase();
        }        
    }
    function mudar_atendente_select(id, display_atendente){
        let selectAtendente = document.getElementById('selectAtendente-'+id);
        selectAtendente.innerText = display_atendente;   
    }
    function mudar_status(hash, status){
        
        var url = "{% url 'chamados:api_status' %}"; 
        formData = new FormData();
        formData.append('hash', hash);
        formData.append('status', status);
        formData.append('csrfmiddlewaretoken', '{{csrf_token}}');
		postRequest(url, formData)
							.then(response => {
                                if (response.status == 200){
                                    alert(response.message +" (" + response.status+")")
                                    mudar_status_select(response.id, response.display_status)                              
                                    
                                }else{
                                    alert(response.message +" (" + response.status+")")
                                }                                   
							})
							.catch(error => {
                                alert('Erro ao mudar status. Tente novamente mais tarde.')
								console.error(error)
							});				
    }
   
    function mudar_prioridade(hash, prioridade){
        var url = "{% url 'chamados:api_prioridade' %}"; 
        formData = new FormData();
        formData.append('hash', hash);
        formData.append('prioridade', prioridade);
        formData.append('csrfmiddlewaretoken', '{{csrf_token}}');
		postRequest(url, formData)
							.then(response => {
                                if (response.status == 200){
                                    // alert(response.message +" (" + response.status+")")
                                    mudar_prioridade_select(response.id, response.display_prioridade)
                                }else{
                                    alert(response.message +" (" + response.status+")")
                                }                                   
							})
							.catch(error => {
                                alert('Erro ao mudar status. Tente novamente mais tarde.')
								console.error(error)
							});				
    }
    function mudar_atendente(hash, atendente){
        var url = "{% url 'chamados:api_atendente' %}"; 
        formData = new FormData();
        formData.append('hash', hash);
        formData.append('atendente', atendente);
        formData.append('csrfmiddlewaretoken', '{{csrf_token}}');
		postRequest(url, formData)
							.then(response => {
                                if (response.status == 200){
                                    // alert(response.message +" (" + response.status+")")
                                    mudar_atendente_select(response.id, response.display_atendente)
                                }else{
                                    alert(response.message +" (" + response.status+")")
                                }                                   
							})
							.catch(error => {
                                alert('Erro ao mudar status. Tente novamente mais tarde.')
								console.error(error)
							});				
    }

        </script>

        <!-- SCRIPT PARA VERIFICAR ATUALIZAÇÕES OU CRIAÇÃO DE NOVOS CHAMADOS -->
        <script>
            let lastCheck = new Date().toISOString();
            let totalNovosChamados = 0; 
            let totalAtualizacoes = 0;  

            // function verificarAtualizacoes() {
                
            //     fetch(`{% url 'chamados:verificar-atualizacoes' %}?last_check=${lastCheck}`)
            //         .then(response => response.json())
            //         .then(data => {
            //             lastCheck = data.last_check; 

            //             const novosChamados = data.novos_chamados;
            //             const atualizacoes = data.atualizacoes;

            //             totalNovosChamados += novosChamados;
            //             totalAtualizacoes += atualizacoes;

            //             const indicativoDiv = document.getElementById("indicativo-atualizacao");
            //             if (totalNovosChamados > 0 || totalAtualizacoes > 0) {
            //                 let novosTicketsTexto;
            //                 let atualizacoesTexto;

            //                 // Define o texto para novos tickets
            //                 if (totalNovosChamados === 1) {
            //                     novosTicketsTexto = `<span class="novo-ticket"> <span class='total-novos-chamados'>${totalNovosChamados}</span> novo ticket</span>`;
            //                 } else {
            //                     novosTicketsTexto = `<span class="novo-ticket"> <span class='total-novos-chamados'>${totalNovosChamados}</span> novos tickets</span>`;
            //                 }

            //                 // Define o texto para atualizações
            //                 if (totalAtualizacoes === 1) {
            //                     atualizacoesTexto = `<span class="atualizacao"> <span class='total-atualizacoes'>${totalAtualizacoes}</span> atualização</span>`;
            //                 } else {
            //                     atualizacoesTexto = `<span class="atualizacao"> <span class='total-atualizacoes'>${totalAtualizacoes}</span> atualizações</span>`;
            //                 }

            //                 // Atualiza o conteúdo da div
            //                 indicativoDiv.innerHTML = `<i class="fa-solid fa-rotate"></i> ${novosTicketsTexto} | ${atualizacoesTexto}`;
            //                 indicativoDiv.style.display = 'flex';
            //             }
            //         })
            //         .catch(error => console.error("Erro ao verificar atualizações:", error));
            // }

            // Intervalo para verificar atualizações a cada 5 segundos
            // setInterval(verificarAtualizacoes, 5000);

            // Função para recarregar a página quando o usuário clica na div de notificação
            function recarregarPagina() {
                totalNovosChamados = 0;
                totalAtualizacoes = 0;
                location.reload();
            }
            function confirmarAcao(){
                if (confirm('Deseja realmente excluir este chamado?')) {
                    return true;
                } else {
                    return false;
                }
            }
            function toggleMenuAcoes(){
                div = document.getElementById('menuAcoes');
                btn = document.getElementById('btnMenuAcoes');
                div.classList.toggle('showAction');
                div.classList.toggle('hidden');
                btn.classList.toggle('text-success');


            }
            function mesclarChamados(selectedIds){
                        var url = "{% url 'chamados:mesclar' %}"; 
                        formData = new FormData();
                        formData.append('chamados', selectedIds);
                        formData.append('csrfmiddlewaretoken', '{{csrf_token}}');
                        postRequest(url, formData)
                            .then(response => {
                                if (response.status == 200){
                                    alert(response.message +" (" + response.status+")")
                                    location.reload();
                                }else{
                                    alert(response.message +" (" + response.status+")")
                                }                                   
                            })
                            .catch(error => {
                                alert('Erro ao mesclar chamados. Tente novamente mais tarde.')
                                console.error(error)
                            });				
            }
            function realizarAcao(){
                valor = confirmarAcao();
                console.log(valor)
                document.getElementById("acoes").selectedIndex = 0;

                if (valor){
                    const checkboxes = document.querySelectorAll('.checkbox-tickets:checked');
                    const selectedIds = Array.from(checkboxes).map(checkbox => checkbox.closest('.row.ticket-chamado-background').id.replace('chamado-', ''));
                    
                    if (selectedIds.length < 2) {
                        alert('Selecione pelo menos um chamado para realizar a ação.');
                        return;
                    }
                    mesclarChamados(selectedIds);

                    
                }

            }
            {% if is_atendente %}
            function enviarDetalhes(){
                let divResponse = document.getElementById('response-relatorio');
                divResponse.className = ''
                divResponse.innerHTML = ''
                let form = document.getElementById('formRelatorio');
                let formData = new FormData(form);
                hash = document.getElementById('hash').value;
                let url = '/chamados/api/{hash}/relatorio/'.replace('{hash}', hash);
                postRequest(url, formData)
                                    .then(response => {
                                        if (response.status == 200){
                                            divResponse.className = 'bg-success text-white text-center mb-3'
                                            divResponse.innerHTML = 'Relatório enviado com sucesso.'
                                            closeModal('modalStatus')
                                        }else{
                                            alert(response.message +" (" + response.status+")")
                                        }                                   
                                    })
                                    .catch(error => {
                                        divResponse.className = 'bg-danger text-white text-center mb-3'
                                        divResponse.innerHTML = 'Erro ao enviar relatório. Tente novamente mais tarde.'
                                        console.error(error)
                                    });
            }
            {% endif %}
            document.getElementById("indicativo-atualizacao").addEventListener("click", recarregarPagina);
        </script>
        
        {% if is_atendente %}
        <div id="modalGrafPorTipo" class="modal" tabindex="-1" style="background-color: #5d677867;">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Grafíco por Tipo de Chamado</h5>
                    <button class="btn btn-primary btn-close" onclick="closeModal('modalGrafPorTipo')">
                        
                    </button>	
                </div>
                <div class="modal-body">
                    <div class="col-12 col-md-12">			
                        <canvas id="canvas-chart3" ></canvas>                        
                    </div>
                </div>           
                </div>
            </div>
            </div>
        {% endif %}

{% endblock %}
